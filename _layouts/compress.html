---
layout: none
---

{%- comment -%}
===========================================================================
  STEP 0: READ ORIGINAL CONTENT
===========================================================================
{%- endcomment -%}

{% capture _content %}{{ content }}{% endcapture %}


{%- comment -%}
===========================================================================
  STEP 1: SAFE MERMAID PROTECTION BEFORE COMPRESSION
    - We extract:
        <div class="mermaid"> ... </div>
      as whole blocks
    - Store them into an array-like string
    - Replace each with a placeholder token
===========================================================================
{%- endcomment -%}

{%- assign MERMAID_OPEN = '<div class="mermaid">' -%}
{%- assign MERMAID_CLOSE = '</div>' -%}

{%- assign _mermaid_blocks = '' -%}
{%- assign index = 0 -%}

{%- capture processed %}{% endcapture %}
{%- assign left = _content -%}

{%- while left contains MERMAID_OPEN -%}

  {%- assign before = left | split: MERMAID_OPEN | first -%}
  {%- assign after_open = left 
        | remove_first: before 
        | remove_first: MERMAID_OPEN 
  -%}
  {%- assign inside = after_open | split: MERMAID_CLOSE | first -%}
  {%- assign after = after_open 
        | remove_first: inside 
        | remove_first: MERMAID_CLOSE 
  -%}

  {%- capture processed %}{{ processed }}{{ before }}<<<MERMAID-BLOCK-{{ index }}>>>{% endcapture %}

  {%- capture block %}{{ MERMAID_OPEN }}{{ inside }}{{ MERMAID_CLOSE }}{% endcapture %}
  {%- assign _mermaid_blocks = _mermaid_blocks | append: block | append: "<<<END>>>" -%}

  {%- assign left = after -%}
  {%- assign index = index | plus: 1 -%}

{%- endwhile -%}

{%- capture processed %}{{ processed }}{{ left }}{% endcapture %}
{%- assign _content = processed -%}


{%- comment -%}
===========================================================================
  STEP 2: COMPRESS THE NON-MERMAID CONTENT
    (This is the original Jekyll HTML compress filter)
===========================================================================
{%- endcomment -%}

{% capture compressed %}
  {{- _content 
      | replace: "\n", " "
      | replace: "\r", " "
      | strip_newlines
      | replace: "  ", " "
      | replace: "> <", "><"
      | replace_regex: "\\s+", " "
  -}}
{% endcapture %}

{%- assign final_output = compressed -%}


{%- comment -%}
===========================================================================
  STEP 3: RESTORE MERMAID BLOCKS
    - Replace placeholder tokens with the original Mermaid HTML
=========================================================================== 
{%- endcomment -%}

{%- assign restored = final_output -%}
{%- assign blocks = _mermaid_blocks | split: '<<<END>>>' -%}

{%- for i in (0..blocks.size) -%}
  {%- assign token = '<<<MERMAID-BLOCK-' | append: i | append: '>>>' -%}
  {%- assign block = blocks[i] -%}
  {%- assign restored = restored | replace: token, block -%}
{%- endfor -%}

{{ restored }}

